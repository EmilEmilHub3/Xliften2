<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Movie Vault</title>
    <link href="SimpleStyle.css" rel="stylesheet" />

    <script>
        // Always call the backend via the /api prefix — nginx will proxy these requests to the .NET API.
        const apiBase = "/api";
        // JWT stored in memory; persistent token is kept in localStorage under 'jwt'
        let jwtToken = null;

        // Wait until DOM is ready before wiring up event handlers.
        document.addEventListener('DOMContentLoaded', function () {

            // -----------------------------
            // LOGIN HANDLING
            // -----------------------------
            // Authenticate user and store JWT on success.
            document.getElementById("btnLogin").onclick = async () => {

                // Read credentials from the input fields.
                const username = document.getElementById("username").value;
                const password = document.getElementById("password").value;

                // Send login request to API.
                const response = await fetch(`${apiBase}/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                // Handle unsuccessful login.
                if (!response.ok) {
                    alert("Login failed.");
                    return;
                }

                // Store received JWT for subsequent requests.
                const data = await response.json();
                jwtToken = data.token;
                localStorage.setItem("jwt", jwtToken);

                alert("Login successful!");

                // Load available videos after successful login.
                await loadVideos();
            };

            // -----------------------------
            // LOAD VIDEO LIST (requires token)
            // -----------------------------
            // Fetches list of videos from API and populates the select element.
            async function loadVideos() {

                // Try to read token from localStorage (persisted across reloads).
                jwtToken = localStorage.getItem("jwt");

                if (!jwtToken) {
                    alert("You must login first.");
                    return;
                }

                // Call the protected /videos endpoint with Authorization header.
                const response = await fetch(`${apiBase}/videos`, {
                    headers: {
                        "Authorization": "Bearer " + jwtToken
                    }
                });

                if (!response.ok) {
                    alert("Could not load videos. Unauthorized?");
                    return;
                }

                // Populate the dropdown with returned video metadata.
                const data = await response.json();
                const select = document.getElementById('movielist');
                select.innerHTML = '';

                data.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.id;
                    opt.innerHTML = v.title;
                    select.appendChild(opt);
                });
            }

            // -----------------------------
            // WATCH A VIDEO
            // -----------------------------
            // Downloads the selected video using the stored JWT and plays it in the <video> element.
            document.getElementById("btnWatchMovie").onclick = async () => {
                const id = document.getElementById("movielist").value;

                if (!id) {
                    alert("Choose a video first.");
                    return;
                }

                const token = localStorage.getItem("jwt");
                if (!token) {
                    alert("Not logged in.");
                    return;
                }

                try {
                    // Request the video stream from the API. The API returns the file bytes.
                    const response = await fetch(`${apiBase}/video/` + encodeURIComponent(id), {
                        headers: { "Authorization": "Bearer " + token }
                    });

                    if (!response.ok) {
                        throw new Error("Could not download video. Status " + response.status);
                    }

                    // Convert response to a Blob and create an object URL for the video player.
                    const blob = await response.blob();
                    const videoUrl = URL.createObjectURL(blob);

                    const player = document.getElementById("videoPlayer");
                    player.src = videoUrl;
                    player.play();

                } catch (err) {
                    console.error(err);
                    alert("Error while loading video.");
                }
            };

        });
    </script>

</head>

<body>

    <div class="container">

        <h1>The Video Vault</h1>

        <!-- LOGIN -->
        <div style="margin-bottom: 20px;">
            <h2>Login</h2>
            <!-- Username input -->
            <input type="text" placeholder="username" id="username" />
            <!-- Password input -->
            <input type="password" placeholder="password" id="password" />
            <!-- Triggers authentication flow -->
            <button id="btnLogin">Login</button>
        </div>

        <!-- VIDEO LIST: populated after successful login -->
        <div>
            <select id="movielist"></select>
        </div>

        <!-- Button to start video playback for the selected video -->
        <div>
            <button class="button button1" id="btnWatchMovie">Watch movie</button>
        </div>

        <!-- VIDEO PLAYER: plays the downloaded Blob URL -->
        <div class="itemSpan2">
            <video id="videoPlayer" width="650" controls autoplay>
                <source type="video/mp4" />
            </video>
        </div>

    </div>

</body>
</html>